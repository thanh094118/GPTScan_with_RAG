name: "incorrect_storage_key_handling"
property:
  - "Incorrect storage key handling in resolve_bet()"
  - "causes the record to overwrite and accounting issues"
activate: "yes"
functions:
  - "resolve_bet"
function_inside:
  - "state.bet_id"
  - "bet.bet_id"
  - "GAME"
static:
  format: "json"
  prompt: |
    Analyze the `resolve_bet()` function. Identify and extract:
    - ActualKeyUsed: The variable or expression explicitly used as the storage key for game records (e.g., the part inside GAME[...]).
    - CorrectKeySource: The variable or expression that represents the unique bet ID and *should* be used as the storage key to prevent overwrites.
    Return as JSON: {"ActualKeyUsed": "...", "CorrectKeySource": "..."}
  output_keys:
    - "ActualKeyUsed"
    - "CorrectKeySource"
  rule:
    name: "find_data_dependency"
    args:
      - "ActualKeyUsed"
      - "CorrectKeySource"
output:
  title: "Incorrect storage key handling in resolve_bet() causes the record to overwrite and accounting issues"
  description: "When resolving multiple bets, the `resolve_bet()` function uses the global `state.bet_id` as the key instead of the unique `bet.bet_id`, causing records to be overwritten."
  recommendation: "Ensure that a unique identifier, such as `bet.bet_id`, is used as the storage key instead of a global or non-unique identifier like `state.bet_id` to prevent data overwrites and maintain correct accounting."